name: build and push workflow
run-name: build and push ${{ inputs.microservice }}

on:
  workflow_call:
    inputs:
      microservice:
        type: string
        required: true
        description: 'Target microservice (react, angular, dotnet)'
      image_tag:
        type: string
        required: false
        default: "latest"
      vite_env:
        type: string
        required: false
        default: "production"
      api_url:
        type: string
        required: false
        default: "http://localhost:8080"

  workflow_dispatch:
    inputs:
      microservice:
        description: 'Target microservice'
        required: true
        type: choice
        options:
          - react
          - angular
          - dotnet
      image_tag:
        description: 'Docker image tag'
        required: false
        default: "latest"
      vite_env:
        description: 'VITE_ENV'
        required: false
        default: "production"
      api_url:
        description: 'VITE_API_URL'
        required: false
        default: "http://localhost:8080"

jobs:
  build-and-push:
    name: build ${{ inputs.microservice }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read

    env:
      IMAGE_TAG: ${{ inputs.image_tag }}
      VITE_ENV: ${{ inputs.vite_env }}
      VITE_API_URL: ${{ inputs.api_url }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set environment variables
        id: vars
        uses: ./.github/actions/set-var
        with:
          microservice: ${{ inputs.microservice }}
          docker_hub_username: ${{ secrets.DOCKER_HUB_USERNAME }}
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION || 'eu-central-1' }} 

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v4
        with:
          context: ${{ env.CONTEXT }}
          file: ${{ env.DOCKERFILE }}
          push: true
          build-args: |
            VITE_ENV=${{ env.VITE_ENV }}
            VITE_API_URL=${{ env.VITE_API_URL }}
          tags: |
            ${{ env.REPO }}:${{ env.IMAGE_TAG }}
            ${{ env.REPO }}:${{ env.SHORT_SHA }}

      - name: Notify about successful build
        if: success()
        run: |
          echo "::notice::Successfully built and pushed image ${IMAGE_TAG} for microservice ${MICROSERVICE}"
